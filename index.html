<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ESP8266 Kontrol Paneli</title>

  <!-- Firebase SDK'ları -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .relay-button { margin: 5px; padding: 10px 20px; font-size: 16px; }
    .status { margin-top: 20px; }
  </style>
</head>
<body>

  <h1>ESP8266 Kontrol Paneli</h1>

  <div id="loginDiv">
    <h3>Giriş Yap</h3>
    <input type="email" id="email" placeholder="E-posta" /><br /><br />
    <input type="password" id="password" placeholder="Şifre" /><br /><br />
    <button id="loginBtn">Giriş</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <div id="controlDiv" style="display:none;">
    <h3>Röle Kontrol</h3>
    <button class="relay-button" id="relay1Btn">Röle 1</button>
    <button class="relay-button" id="relay2Btn">Röle 2</button>
    <button class="relay-button" id="relay3Btn">Röle 3</button>
    <button class="relay-button" id="relay4Btn">Röle 4</button>

    <div class="status">
      <p>Sıcaklık: <span id="temp">Yükleniyor...</span> °C</p>
      <p>Nem: <span id="hum">Yükleniyor...</span> %</p>
    </div>

    <button id="logoutBtn" style="margin-top: 20px;">Çıkış Yap</button>
  </div>

  <script>
    // Firebase config senin bilgilerle doldur
    const firebaseConfig = {
      apiKey: "AIzaSyC0ABFX15WZgwRlSsCaNW8X2LPabTRZFV4",
      authDomain: "nodemcu-990e0.firebaseapp.com",
      databaseURL: "https://nodemcu-990e0-default-rtdb.firebaseio.com",
      projectId: "nodemcu-990e0",
      storageBucket: "nodemcu-990e0.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Firebase başlat
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.database();

    const loginDiv = document.getElementById('loginDiv');
    const controlDiv = document.getElementById('controlDiv');
    const loginError = document.getElementById('loginError');

    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');

    const relayButtons = {
      relay1: document.getElementById('relay1Btn'),
      relay2: document.getElementById('relay2Btn'),
      relay3: document.getElementById('relay3Btn'),
      relay4: document.getElementById('relay4Btn')
    };

    // Giriş butonu
    document.getElementById('loginBtn').addEventListener('click', () => {
      const email = emailInput.value;
      const password = passwordInput.value;
      loginError.textContent = "";

      auth.signInWithEmailAndPassword(email, password)
      .then(() => {
        loginDiv.style.display = 'none';
        controlDiv.style.display = 'block';
        setupRelayListeners();
        updateSensorValues();
      })
      .catch(error => {
        loginError.textContent = "Giriş hatası: " + error.message;
      });
    });

    // Çıkış butonu
    document.getElementById('logoutBtn').addEventListener('click', () => {
      auth.signOut();
      loginDiv.style.display = 'block';
      controlDiv.style.display = 'none';
      emailInput.value = "";
      passwordInput.value = "";
    });

    // Röle durumlarını dinle ve buton durumunu güncelle
    function setupRelayListeners() {
      for (const key in relayButtons) {
        db.ref("/" + key).on("value", snapshot => {
          const val = snapshot.val();
          relayButtons[key].textContent = key.toUpperCase() + (val ? " Açık" : " Kapalı");
          relayButtons[key].style.backgroundColor = val ? "green" : "red";
        });

        relayButtons[key].onclick = () => {
          db.ref("/" + key).get().then(snapshot => {
            const currentState = snapshot.val();
            db.ref("/" + key).set(!currentState);
          });
        };
      }
    }

    // Sıcaklık ve nem değerlerini göster
    function updateSensorValues() {
      db.ref("/temperature").on("value", snapshot => {
        document.getElementById("temp").innerText = snapshot.val() || "Yok";
      });
      db.ref("/humidity").on("value", snapshot => {
        document.getElementById("hum").innerText = snapshot.val() || "Yok";
      });
    }

    // Kullanıcı oturum durumu kontrolü
    auth.onAuthStateChanged(user => {
      if (user) {
        loginDiv.style.display = 'none';
        controlDiv.style.display = 'block';
        setupRelayListeners();
        updateSensorValues();
      } else {
        loginDiv.style.display = 'block';
        controlDiv.style.display = 'none';
      }
    });
  </script>
</body>
</html>
